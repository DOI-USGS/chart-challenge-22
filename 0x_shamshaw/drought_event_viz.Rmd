---
title: "Streamflow Drought Event Visualizations"
author: "Scott Hamshaw"
date: "`r Sys.Date()`"
output: 
        distill::distill_article:
          highlight: kate
          code_folding: true  
          toc: true            
          toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 8)
Sys.setlocale("LC_TIME", "C")
```

## Streamflow Drought Event Data Visualization

Exploring approaches to visualize streamflow drought events in the Colorado River Basin region

### Packages and General themes

```{r load_packages}
library(tidyverse)
library(lubridate)
library(knitr)
library(ggthemes)
library(patchwork)
library(paletteer)
library(ggdist)
library(ggforce)
library(ggdark)
library(streamgraph)
library(ggHoriPlot)
library(zoo)
library(xts)
```

```{r plot_themes}
theme_set(theme_void(base_family = "sans"))

theme_update(
  axis.text.x = element_text(color = "black", face = "plain", size = 18, 
                             margin = margin(t = 6)),
  axis.text.y = element_text(color = "black", size = 20, hjust = 1, 
                             margin = margin(r = 6), family = "sans"),
  axis.line.x = element_line(color = "black", size = 1),
  panel.grid.major.y = element_line(color = "grey90", size = .6),
  plot.background = element_rect(fill = "white", color = "white"),
  plot.margin = margin(rep(20, 4)),
  legend.text = element_text(family = "sans", size = 16),
  plot.title = element_text(size=22),
  axis.title = element_text(size = 20),
  axis.title.y = element_text(angle=90)
)

## theme for horizontal charts
theme_flip <-
  theme(
    axis.text.x = element_text(face = "plain", family = "sans", size = 18),
    axis.text.y = element_text(face = "bold", family = "sans", size = 22),
    panel.grid.major.x = element_line(color = "grey90", size = .6),
    panel.grid.major.y = element_blank(),
    legend.position = "top", 
    legend.text = element_text(family = "sans", size = 18),
    legend.title = element_text(face = "bold", size = 18, margin = margin(b = 25)),
    axis.title = element_text(size = 20),
    plot.title = element_text(size=22)
  )

# color palettes
c_pal = paletteer_d("ggsci::default_uchicago") #9 color palette
c_pal2 = paletteer_d("ghibli::MarnieMedium2") # -- 7 color palette
c_pal3 = paletteer_d("ggsci::blue_material")
# ggsci::springfield_simpsons # -- 20 color palette

```

### Load data

Load drought event properties data

```{r}
# Streamflow drought events calculated using Julian day 30-day moving window method 
# for 1980-2020 for gages in Colorado River Basin region. 
# Data file from regional drought early warning project 
# Data > Data from National Project > Streamflow > Drought Summaries
events_crb_jd_1980 <- read_csv("data/weibull_jd_30d_wndw_Drought_Properties.csv") %>% 
  mutate(uniq_drought_id = str_c(StaID,"_",drought_id))  # add a unique drought ID across all sites

# Streamflow drought events calculated using long-term site method 
# for 1980-2020 for gages in Colorado River Basin region. 
# Data file from regional drought early warning project 
# Data > Data from National Project > Streamflow > Drought Summaries
events_crb_site_1980 <- read_csv("data/weibull_site_Drought_Properties.csv") %>% 
  mutate(uniq_drought_id = str_c(StaID,"_",drought_id))  # add a unique drought ID across all sites

# Streamflow drought events calculated using Julian day method 
# on 7-day average streamflows for 1921-2020 for Gages II sites that have sufficient records. 
# Data file from national drought characterization project 
events_conus_jd_1921 <- read_csv("data/streamflow_percentiles_7dayaverage_1921-2020_weibull_jd_Drought_Properties.csv") %>% 
  rename(StaID = site) %>% 
  mutate(StaID = str_remove(StaID,"SW")) %>% 
  mutate(uniq_drought_id = str_c(StaID,"_",drought_id))  # add a unique drought ID across all sites

# Streamflow drought events calculated using Julian day method 
# on 7-day average streamflows for 1951-2020 for Gages II sites that have sufficient records. 
# Data file from national drought characterization project 
events_conus_jd_1951 <- read_csv("data/streamflow_percentiles_7dayaverage_1951-2020_weibull_jd_Drought_Properties.csv") %>% 
  rename(StaID = site) %>% 
  mutate(StaID = str_remove(StaID,"SW")) %>% 
  mutate(uniq_drought_id = str_c(StaID,"_",drought_id))  # add a unique drought ID across all sites
 
```

Gage metadata information

```{r}
# Read in gage metadata for sites that are part of RDEWS project
rdews_gages <- read_csv("data/all_gages_metadata.csv") %>% 
  rename(StaID = site) %>% 
  # do some recoding of categorical gage characteristics into factors
  rename(HCDN2009 = HCDN.2009) %>% 
  mutate(HCDN2009 = as.factor(HCDN2009)) %>% 
  mutate(HCDN2009 = fct_explicit_na(HCDN2009, na_level = "Non-HCDN")) %>%
  mutate(HCDN2009 = recode_factor(HCDN2009, "yes" = "HCDN(2009)" )) %>% 
  mutate(HLR_Description = as.factor(HLR_Description)) %>% 
  mutate(HLR = as.factor(HLR)) %>% 
  mutate(elev_range = as.factor(elev_range)) %>% 
  mutate(DA_range = as.factor(DA_range)) %>%
  mutate(HUC02 = as.factor(HUC02)) %>% 
  mutate(CRB= fct_other(HUC02, keep = c("14", "15"), other_level = 'Outside CRB')) %>% 
  mutate(CRB= recode_factor(CRB, "14" = "Upper Colorado", "15" = "Lower Colorado" )) %>% 
  mutate(HUC02 = recode_factor(HUC02, "10U" = "Upper Missouri", "10L" = "Lower Missouri", "11" = "Arkansas-White-Red", "13" = "Rio Grande", "14" = "Upper Colorado", "15" = "Lower Colorado", "16"="Great Basin", "17" = "Pacific Northwest", "18" = "California" ))

# read in metadata for GagesII sites compiled from the national drought characterization project
gages2_meta <- read_csv("data/gagesII_metadata.csv") %>% 
  rename(StaID = STAID) %>% 
  rename(HCDN2009 = `HCDN-2009`) %>% 
  mutate(HCDN2009 = as.factor(HCDN2009)) %>% 
  mutate(HCDN2009 = fct_explicit_na(HCDN2009, na_level = "Non-HCDN")) %>%
  mutate(HCDN2009 = recode_factor(HCDN2009, "yes" = "HCDN(2009)" )) %>% 
  mutate(HUC02 = as.factor(HUC02)) %>% 
  mutate(CRB= fct_other(HUC02, keep = c("14", "15"), other_level = 'Outside CRB')) %>% 
  mutate(CRB= recode_factor(CRB, "14" = "Upper Colorado", "15" = "Lower Colorado" )) %>% 
  mutate(HUC02 = recode_factor(HUC02, "10U" = "Upper Missouri", "10L" = "Lower Missouri", "11" = "Arkansas-White-Red", "13" = "Rio Grande", "14" = "Upper Colorado", "15" = "Lower Colorado", "16"="Great Basin", "17" = "Pacific Northwest", "18" = "California" ))
```


### Beeswarms of individual drought events

Plot individual drought events over time across in a few different ways

```{r, fig.cap="Occurrence of 2% Julian day threshold streamflow drought events at watersheds smaller than 1000 sq km since 1980"}
events_by_region <- events_crb_jd_1980 %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <1000) %>% 
  filter(threshold == 2) %>% 
  filter(HUC02 %in% c("Upper Colorado","Lower Colorado"))

hbreaks <- BAMMtools::getJenksBreaks(events_by_region$duration, k=10)
scaledBreaks <- scales::rescale(hbreaks, c(0,1))

p <- ggplot(data = events_by_region, aes(x = start, y = HUC02, color = duration, fill = duration, size = duration)) +
  ggbeeswarm::geom_quasirandom( width = .33, alpha = .9, groupOnX = FALSE) + 
  scale_color_paletteer_c("scico::buda",values = scaledBreaks, direction = 1) +
  scale_fill_paletteer_c("scico::buda",values = scaledBreaks, direction = 1) +
  ylab(element_blank()) + 
  xlab(element_blank())+
  dark_theme_gray()+
  theme(plot.background = element_rect(fill = "grey10"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey30", size = 0.2),
        panel.grid.minor = element_line(color = "grey30", size = 0.2),
        legend.background = element_blank())
p
```

```{r, fig.cap="Occurrence of 2% Julian day threshold streamflow drought events at watersheds smaller than 1000 sq km since 1980"}
events_by_region <- events_crb_jd_1980 %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <1000) %>% 
  filter(threshold == 20) %>% 
  filter(HUC02 %in% c("Upper Colorado","Lower Colorado"))

hbreaks <- BAMMtools::getJenksBreaks(events_by_region$duration, k=10)
scaledBreaks <- scales::rescale(hbreaks, c(0,1))

p <- ggplot(data = events_by_region, aes(x = start, y = HUC02, color = duration, fill = duration, size = duration)) +
  ggbeeswarm::geom_quasirandom( width = .33, alpha = .9, groupOnX = FALSE) + 
  scale_color_paletteer_c("scico::imola",values = scaledBreaks, direction = 1) +
  scale_fill_paletteer_c("scico::imola",values = scaledBreaks, direction = 1) +
  ylab(element_blank()) + 
  xlab(element_blank())+
  dark_theme_gray()+
  theme(plot.background = element_rect(fill = "grey10"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey30", size = 0.2),
        panel.grid.minor = element_line(color = "grey30", size = 0.2),
        legend.background = element_blank())
p
```

```{r, fig.cap="Occurrence of 2% threshold streamflow drought events at watersheds smaller than 1000 sq km since 1951"}
events_crb <- events_conus_jd_1951 %>% 
  inner_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <1000) %>% 
  filter(threshold == 2) %>% 
  filter(in_crb == TRUE)

hbreaks <- BAMMtools::getJenksBreaks(events_crb$duration, k=10)
scaledBreaks <- scales::rescale(hbreaks, c(0,1))

p <- ggplot(data = events_crb, aes(x = start, y = in_crb, color = duration, fill = duration, size = duration)) +
  ggbeeswarm::geom_quasirandom( width = .33, alpha = .9, groupOnX = FALSE) + 
  scale_color_paletteer_c("scico::lajolla",values = scaledBreaks, direction = 1) +
  scale_fill_paletteer_c("scico::lajolla",values = scaledBreaks, direction = 1) +
  ylab(element_blank()) + 
  xlab(element_blank())+
  theme(axis.text.y=element_blank())
p
```

```{r, fig.cap="Occurrence of 2% threshold streamflow drought events at watersheds smaller than 10,000 sq km since 1921"}
events_crb <- events_conus_jd_1921 %>% 
  inner_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <10000) %>% 
  filter(threshold == 2) %>% 
  filter(in_crb == TRUE)

hbreaks <- BAMMtools::getJenksBreaks(events_crb$duration, k=10)
scaledBreaks <- scales::rescale(hbreaks, c(0,1))

p <- ggplot(data = events_crb, aes(x = start, y = in_crb, color = duration, fill = duration, size = duration)) +
  ggbeeswarm::geom_quasirandom( width = .33, alpha = .9, groupOnX = FALSE) + 
  scale_color_paletteer_c("scico::hawaii",values = scaledBreaks, direction = -1) +
  scale_fill_paletteer_c("scico::hawaii",values = scaledBreaks, direction = -1) +
  ylab(element_blank()) + 
  xlab(element_blank())+
  theme(axis.text.y=element_blank())
p
```


### Streamgraph plots of streamflow percentile

Instead of plotting drought events as single objects, try plotting streamflow percentiles over time

```{r load_percentiles}
###### Read in streamflow percentiles calculated using Julian day thresholds 
tbl_fread <-
    list.files(path = "C:/Users/shamshaw/DOI/GS-WMA-DROUGHT RegionalDroughtEarlyWarning - Documents/General/Data/Data_From_National_Project/Streamflow/Streamflow_percentiles_extra_columns",
               pattern = "*.csv",
               full.names = T) %>%
    map_df(~read_csv(., show_col_types = FALSE, col_types = cols(StaID = "c")))

all_streamflow <- tbl_fread %>%
  drop_na(weibull_jd)

rm(tbl_fread)

# drought/no-drought binary classification for RDEWS sites
drought_classes <- read_csv("data/Binary_classes_all_thresholds.csv") 

drought_classes <- drought_classes %>% 
  rename(StaID = "site") %>% 
  rename(dt = "date")

all_streamflow <- all_streamflow %>% left_join(drought_classes, by = c("dt", "StaID"))
```

```{r, fig.cap="Streamflow percentile (Julian day method) for HCDN gages in Upper Colorado from 2010 to 2020"}
# select streamflow percentile data for a subset (n = 14) of upper Colorado River HCDN gages
plot_dat <- all_streamflow %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(HCDN2009 == "HCDN(2009)") %>% 
  filter(HUC02 == "Upper Colorado") %>% 
  select(dt, StaID, weibull_jd_30d_wndw) %>% 
  mutate(perc =  100 - weibull_jd_30d_wndw) %>% 
  filter(dt >= "2009-10-01")

p <- streamgraph(plot_dat, "StaID", "perc", "dt", interactive=FALSE) %>%
  sg_axis_x(20, "dt", "%b-%Y") %>%
  sg_fill_manual(c_pal2)
p
```

```{r, fig.cap="Weekly streamflow percentile (Julian day method) for HCDN gages in Upper Colorado from 2015 to 2020"}
# select streamflow percentile data for a subset (n = 14) of upper Colorado River HCDN gages
plot_dat <- all_streamflow %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(HCDN2009 == "HCDN(2009)") %>% 
  filter(HUC02 == "Upper Colorado") %>% 
  select(dt, StaID, weibull_jd_30d_wndw) %>% 
  mutate(perc = 100 - weibull_jd_30d_wndw) %>% 
  filter(dt >= "2014-10-01")

# Aggregate to weekly time step
plot_dat <- plot_dat %>% 
  group_by(StaID, year = year(dt), week = week(dt)) %>%
  summarise(perc_7day = mean(perc),
            date = first(dt))

p <- streamgraph(plot_dat, "StaID", "perc_7day", "date", interactive=FALSE) %>%
  sg_axis_x(20, "date", "%b-%Y") %>%
  sg_fill_manual(sample(c_pal3))
p
```

### Tile/raster plot of streamflow events

Show the extent(represented by the number of gages) that are in drought on a given day over time

```{r, fig.cap="Extent (number of sites) experiencing a 5% Julian day threshold drought event between 1980 and 2020 in the Upper Colorado River basin"}
plot_dat <- all_streamflow %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <= 1000) %>% 
  filter(HUC02 == "Upper Colorado") %>% 
  select(dt, StaID, drought_5_jd) %>% 
  group_by(dt) %>% 
  summarize(sites_in_drought = sum(drought_5_jd)) %>% 
  mutate(jd = yday(dt)) %>% 
  mutate(year = year(dt)) %>% 
  filter(sites_in_drought > 0)
  

p <- plot_dat %>% ggplot() +
  geom_tile(aes(x=jd, y=year, fill=sites_in_drought))+
  scale_fill_paletteer_c("scico::tokyo", direction =1)+
  scale_y_reverse()+
  dark_theme_gray()
p
```

```{r, fig.cap="Extent (number of sites) experiencing a 20% Julian day threshold drought event between 1980 and 2020 in the Upper Colorado River basin"}
plot_dat <- all_streamflow %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(DRAIN_SQKM <= 1000) %>% 
  filter(HUC02 == "Upper Colorado") %>% 
  select(dt, StaID, drought_20_jd) %>% 
  group_by(dt) %>% 
  summarize(sites_in_drought = sum(drought_20_jd)) %>% 
  mutate(jd = yday(dt)) %>% 
  mutate(year = year(dt)) %>% 
  filter(sites_in_drought > 0)
  

p <- plot_dat %>% ggplot() +
  geom_tile(aes(x=jd, y=year, fill=sites_in_drought))+
  scale_fill_paletteer_c("scico::lapaz", direction =-1)+
  scale_y_reverse()
p
```

### Drought event timelines for Colorado River

Now try to visualize the drought events on timelines for multiple sites. Use gages from the top to bottom of Colorado River as example


```{r fig.cap="Streamflow drought events recorded at gages along the Colorado River"}
# gages along CR with drought data calculated (ordered from upstream to downstream)
CR_gages <- c("09010500", "09034250", "09058000", "09070500", "09085100", "09095500", "09163500", "09180500", "09380000", "09423000", "09427520", "09429490", "09429600", "09522000")

# select streamflow percentile data for a subset (n = 14) of upper Colorado River HCDN gages
plot_dat <- all_streamflow %>% 
  left_join(rdews_gages, by = "StaID", suffix = c("",".gages")) %>% 
  filter(StaID %in% CR_gages) %>% 
  select(dt, StaID, weibull_jd_30d_wndw) %>% 
  mutate(perc = 20 - weibull_jd_30d_wndw) %>% 
  mutate(perc = ifelse(perc <0, 0, perc)) %>% 
  filter((dt >= "2018-04-01" & dt <= "2019-09-30"))

p <- plot_dat %>% ggplot() +
  geom_area(aes(x = dt, y = ifelse(perc >15, perc, 0), fill = c_pal3[10])) +
  geom_area(aes(x = dt, y = ifelse(perc >10 & perc <= 15, perc, 0), fill = c_pal3[6])) +
  geom_area(aes(x = dt, y = ifelse(perc >=0 & perc <= 10, perc, 0), fill = c_pal3[3])) +
  theme(axis.text.y=element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "top")+
  scale_fill_identity(name = "Drought Intensity", labels = c("95th %", "90th %", "80th%"), guide = "legend")+
  labs(y="Streamflow percentile", x = element_blank())+
  facet_wrap(vars(StaID),ncol=1, strip.position = "right")
p
```